<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Chat with Delete</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f9; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #auth-container { text-align: center; }
        #login-button { font-size: 18px; padding: 12px 24px; cursor: pointer; background-color: #4285F4; color: white; border: none; border-radius: 5px; }
        #chat-app { display: none; width: 100%; max-width: 700px; height: 80vh; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        #header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        #logout-button { background-color: #db4437; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        #messages { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .message { display: flex; flex-direction: column; margin-bottom: 15px; position: relative; } /* NEW: Added position relative */
        .message .info { font-size: 0.8em; color: #888; margin-bottom: 4px; }
        .message .text { padding: 10px 15px; border-radius: 20px; max-width: 75%; word-wrap: break-word; }
        .message.sent { align-items: flex-end; }
        .message.sent .text { background-color: #dcf8c6; }
        .message.received { align-items: flex-start; }
        .message.received .text { background-color: #f1f0f0; }
        /* NEW: Styles for the delete button */
        .delete-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: #e0e0e0;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            color: #888;
            font-weight: bold;
            line-height: 20px;
            text-align: center;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.2s;
        }
        .message.sent:hover .delete-button { opacity: 1; } /* Show on hover for sent messages */
        .message.sent .delete-button { left: -30px; }
        #message-form { display: flex; padding: 20px; border-top: 1px solid #eee; }
        #message-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; font-size: 16px; margin-right: 10px; }
        #send-button { background-color: #075e54; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="auth-container">
        <h1>Welcome to Firebase Chat</h1>
        <button id="login-button">Login with Google</button>
    </div>
    <div id="chat-app">
        <div id="header"><span id="user-info"></span><button id="logout-button">Logout</button></div>
        <div id="messages"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" required>
            <button type="submit" id="send-button">âž¤</button>
        </form>
    </div>

    <script>
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCkdV3Dua1NMTDNbBgTUiIy9z8x9Li6Q7I",
            authDomain: "chat-1213d.firebaseapp.com",
            projectId: "chat-1213d",
            storageBucket: "chat-1213d.firebasestorage.app",
            messagingSenderId: "573112377061",
            appId: "1:573112377061:web:213170d961872353a63e0c"
        };

        // --- 2. INITIALIZE FIREBASE & GET ELEMENTS ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const messagesRef = db.collection('messages');
        const authContainer = document.getElementById('auth-container');
        const chatApp = document.getElementById('chat-app');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const userInfo = document.getElementById('user-info');
        const messagesContainer = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');

        let currentUser = null;
        let unsubscribe;

        // --- 3. AUTHENTICATION LOGIC ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                authContainer.style.display = 'none';
                chatApp.style.display = 'flex';
                userInfo.textContent = `Welcome, ${user.displayName}`;
                loadMessages();
            } else {
                currentUser = null;
                authContainer.style.display = 'block';
                chatApp.style.display = 'none';
                if (unsubscribe) unsubscribe();
            }
        });

        loginButton.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => console.error("Login Error:", error));
        });

        logoutButton.addEventListener('click', () => auth.signOut());

        // --- 4. CHAT (FIRESTORE) LOGIC ---
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text && currentUser) {
                await messagesRef.add({
                    text: text,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    uid: currentUser.uid,
                    displayName: currentUser.displayName
                });
                messageInput.value = '';
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        });

        function loadMessages() {
            unsubscribe = messagesRef.orderBy('createdAt').onSnapshot(snapshot => {
                messagesContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const message = doc.data();
                    renderMessage(doc.id, message); // NEW: Pass the document ID
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        // UPDATED: renderMessage now accepts the docId
        function renderMessage(docId, message) {
            const div = document.createElement('div');
            div.classList.add('message');
            div.setAttribute('data-id', docId); // NEW: Set a data attribute with the doc ID

            let deleteButtonHTML = '';
            if (currentUser && message.uid === currentUser.uid) {
                div.classList.add('sent');
                // NEW: Only add the delete button if the message is from the current user
                deleteButtonHTML = `<button class="delete-button">X</button>`;
            } else {
                div.classList.add('received');
            }

            div.innerHTML = `
                ${deleteButtonHTML}
                <div class="info">${message.displayName}</div>
                <div class="text">${message.text}</div>
            `;
            messagesContainer.appendChild(div);
        }

        // --- 5. NEW: DELETE MESSAGE LOGIC ---
        messagesContainer.addEventListener('click', async (e) => {
            // Check if the clicked element is a delete button
            if (e.target.classList.contains('delete-button')) {
                // Find the parent message element and get its ID
                const messageElement = e.target.closest('.message');
                const messageId = messageElement.getAttribute('data-id');

                if (messageId && confirm("Are you sure you want to delete this message?")) {
                    try {
                        // Use the messageId to create a reference to the document and delete it
                        await db.collection('messages').doc(messageId).delete();
                        // The onSnapshot listener will automatically handle removing it from the UI
                    } catch (error) {
                        console.error("Error removing message: ", error);
                        alert("You do not have permission to delete this message.");
                    }
                }
            }
        });
    </script>
</body>
</html>
