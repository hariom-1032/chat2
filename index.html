<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f9; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #auth-container { text-align: center; }
        #login-button { font-size: 18px; padding: 12px 24px; cursor: pointer; background-color: #4285F4; color: white; border: none; border-radius: 5px; }
        #chat-app { display: none; width: 100%; max-width: 700px; height: 80vh; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        #header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        #logout-button { background-color: #db4437; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        #messages { flex-grow: 1; overflow-y: auto; padding: 20px; }
        
        /* --- MODIFIED CSS FOR MESSAGE LAYOUT --- */
        .message { display: flex; flex-direction: column; margin-bottom: 15px; max-width: 85%; }
        .message .info { font-size: 0.8em; color: #888; margin-bottom: 4px; }
        .message-content { display: flex; align-items: center; gap: 8px; } /* NEW: Flex container for text and button */
        .message .text { padding: 10px 15px; border-radius: 20px; word-wrap: break-word; }
        
        .message.sent { align-self: flex-end; align-items: flex-end; } /* Align whole container to the right */
        .message.sent .text { background-color: #dcf8c6; }
        .message.sent .message-content { flex-direction: row-reverse; } /* NEW: Reverses order for sent messages (button on the left) */

        .message.received { align-self: flex-start; align-items: flex-start; } /* Align whole container to the left */
        .message.received .text { background-color: #f1f0f0; }
        
        /* --- NEW: Style for the dedicated delete button --- */
        .delete-btn {
            background-color: #ff4d4d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0; /* Prevents the button from shrinking */
            transition: background-color 0.2s;
        }
        .delete-btn:hover { background-color: #cc0000; }

        #message-form { display: flex; padding: 20px; border-top: 1px solid #eee; }
        #message-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; font-size: 16px; margin-right: 10px; }
        #send-button { background-color: #075e54; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="auth-container">
        <h1>Welcome to Chat</h1>
        <button id="login-button">Login with Google</button>
    </div>
    <div id="chat-app">
        <div id="header"><span id="user-info"></span><button id="logout-button">Logout</button></div>
        <div id="messages"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" required>
            <button type="submit" id="send-button">âž¤</button>
        </form>
    </div>

    <script>
        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCkdV3Dua1NMTDNbBgTUiIy9z8x9Li6Q7I",
            authDomain: "chat-1213d.firebaseapp.com",
            projectId: "chat-1213d",
            storageBucket: "chat-1213d.firebasestorage.app",
            messagingSenderId: "573112377061",
            appId: "1:573112377061:web:213170d961872353a63e0c"
        };

        // --- 2. INITIALIZE FIREBASE & GET ELEMENTS ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const messagesRef = db.collection('messages');
        const authContainer = document.getElementById('auth-container');
        const chatApp = document.getElementById('chat-app');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const userInfo = document.getElementById('user-info');
        const messagesContainer = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');

        let currentUser = null;
        let unsubscribe;

        // --- 3. AUTHENTICATION LOGIC (Unchanged) ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                authContainer.style.display = 'none';
                chatApp.style.display = 'flex';
                userInfo.textContent = `Welcome, ${user.displayName}`;
                loadMessages();
            } else {
                currentUser = null;
                authContainer.style.display = 'block';
                chatApp.style.display = 'none';
                if (unsubscribe) unsubscribe();
            }
        });
        loginButton.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => console.error("Login Error:", error));
        });
        logoutButton.addEventListener('click', () => auth.signOut());

        // --- 4. CHAT (FIRESTORE) LOGIC (Unchanged) ---
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text && currentUser) {
                await messagesRef.add({
                    text: text,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    uid: currentUser.uid,
                    displayName: currentUser.displayName
                });
                messageInput.value = '';
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        });

        function loadMessages() {
            unsubscribe = messagesRef.orderBy('createdAt').onSnapshot(snapshot => {
                messagesContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    renderMessage(doc.id, doc.data());
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        // --- 5. UPDATED RENDER MESSAGE FUNCTION ---
        function renderMessage(docId, message) {
            const div = document.createElement('div');
            div.classList.add('message');

            let contentHTML;

            if (currentUser && message.uid === currentUser.uid) {
                div.classList.add('sent');
                // Structure for a sent message (includes delete button)
                contentHTML = `
                    <div class="message-content">
                        <div class="text">${message.text}</div>
                        <button class="delete-btn" data-id="${docId}">X</button>
                    </div>
                `;
            } else {
                div.classList.add('received');
                // Structure for a received message (no delete button)
                contentHTML = `
                    <div class="message-content">
                        <div class="text">${message.text}</div>
                    </div>
                `;
            }

            div.innerHTML = `
                <div class="info">${message.displayName}</div>
                ${contentHTML}
            `;
            messagesContainer.appendChild(div);
        }

        // --- 6. UPDATED DELETE MESSAGE LOGIC ---
        messagesContainer.addEventListener('click', async (e) => {
            // Check if the clicked element is a delete button
            if (e.target.classList.contains('delete-btn')) {
                // Get the message ID directly from the button's data-id attribute
                const messageId = e.target.getAttribute('data-id');

                if (messageId && confirm("Are you sure you want to delete this message?")) {
                    try {
                        await db.collection('messages').doc(messageId).delete();
                    } catch (error) {
                        console.error("Error removing message: ", error);
                        alert("You do not have permission to delete this message.");
                    }
                }
            }
        });
    </script>
</body>
</html>
